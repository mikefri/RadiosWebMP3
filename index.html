<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com https://accounts.google.com; object-src 'none';">
    <title>Lecteur audio depuis Google Drive</title>
    <style>
        #audio-list div {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #error-message {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        .audio-container { /* Nouvelle classe pour le conteneur audio */
            display: flex; /* Utilisation de flexbox pour l'alignement */
            flex-direction: column;
            align-items: center; /* Centrer le contenu horizontalement */
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 90%; /* Ajuster la largeur selon les besoins */
            max-width: 500px; /* Limiter la largeur maximale si nécessaire */
        }

        .audio-container h3 {
            margin-bottom: 5px; /* Réduire la marge inférieure du titre */
            font-size: 1em;
        }

        .audio-container audio {
            width: 100%; /* L'audio prend toute la largeur du conteneur */
        }

    </style>
</head>
<body>
    <h1>Lecteur audio depuis Google Drive</h1>

    <div id="g_id_onload"
         data-client_id="702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com"
         data-auto_select="false"
         data-itp_support="true"
         data-callback="handleCredentialResponse">
    </div>

    <div class="g_id_signin"
         data-type="standard"
         data-shape="pill"
         data-theme="outline"
         data-text="Se connecter avec Google"
         data-size="large"
         data-client_id="702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com">
    </div>

    <div id="audio-list"></div>
    <div id="error-message"></div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script> <script>
        // Remplacez par l'ID de votre dossier "music" sur Google Drive
        const MUSIC_FOLDER_ID = '11n9RVF-ZjTBOLMvoYB7asAs4A8hUfeYu';  // IMPORTANT : Mettez à jour cet ID !
        const CLIENT_ID = '702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com'; // IMPORTANT : Mettez à jour cet ID !

        let googleAuth;
        let isSignedIn = false;
        let gapiInitialized = false; // Nouveau drapeau pour suivre l'initialisation de gapi


        // Définition de la fonction handleCredentialResponse *avant* son utilisation
        function handleCredentialResponse(response) {
            console.log("ID Token:", response.credential);
            // Ici, vous pouvez envoyer l'ID Token à votre serveur backend pour une authentification plus poussée si nécessaire.
            // Pour cet exemple côté client uniquement, nous allons essayer d'initialiser gapi directement.
            if (!gapiInitialized) { // Vérifie si gapi est initialisé
                gapi.load('client:auth2', initClient); // Charge et initialise si ce n'est pas le cas
            } else {
                initClient(); // Sinon, appelle initClient directement
            }

        }

        // Définition de la fonction gapiLoaded *avant* son utilisation
        function gapiLoaded() {
           gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                clientId: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.readonly'
            }).then(() => {
                gapiInitialized = true; // Marque gapi comme initialisé
                googleAuth = gapi.auth2.getAuthInstance();
                isSignedIn = googleAuth.isSignedIn.get();
                googleAuth.isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(isSignedIn); // Appelle updateSigninStatus pour gérer l'état initial
            }).catch(error => {
                console.error('Erreur lors de l\'initialisation de gapi:', error);
                document.getElementById('error-message').innerText = 'Erreur lors de la connexion à Google.';
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                console.log('Connecté.');
                document.getElementById('error-message').innerText = '';
                listFiles();
            } else {
                console.log('Non connecté.');
                document.getElementById('audio-list').innerHTML = '';
                document.getElementById('error-message').innerText = 'Veuillez vous connecter à Google pour accéder à vos fichiers audio.';
            }
        }

        function listFiles() {
            if (!isSignedIn || !gapi.client || !gapi.client.drive) {
                const errorMessage = 'Erreur : Client Google API non initialisé ou non connecté. Veuillez vous reconnecter.';
                console.error(errorMessage);
                document.getElementById('error-message').innerText = errorMessage;
                return;
            }

            gapi.client.drive.files.list({
                q: `'${11n9RVF-ZjTBOLMvoYB7asAs4A8hUfeYu}' in parents and mimeType contains 'audio' and trashed = false`,
                fields: 'files(id, name, mimeType, webContentLink)'
            }).then(response => {
                const files = response.result.files;
                const audioListDiv = document.getElementById('audio-list');
                audioListDiv.innerHTML = '';

                if (!files || files.length === 0) {
                    audioListDiv.innerText = 'Aucun fichier audio trouvé dans le dossier.';
                    return;
                }

                files.forEach(file => {
                    if (file.webContentLink) {
                        const container = document.createElement('div');
                        container.className = 'audio-container';  // Applique la classe au conteneur
                        container.innerHTML = `
                            <h3>${file.name}</h3>
                            <audio controls>
                                <source src="${file.webContentLink}" type="${file.mimeType}">
                                Votre navigateur ne supporte pas l'audio.
                            </audio>
                        `;
                        audioListDiv.appendChild(container);
                    } else {
                        const message = `Fichier audio sans lien de lecture direct: ${file.name} (ID: ${file.id})`;
                        console.warn(message);
                        const container = document.createElement('div');
                        container.className = 'audio-container';
                        container.innerHTML = `
                            <h3>${file.name}</h3>
                            <p>Lecture impossible : Le fichier n'a pas de lien de lecture direct.</p>
                        `;
                        audioListDiv.appendChild(container);
                    }
                });
            }).catch(error => {
                const errorMessage = 'Erreur lors de la récupération des fichiers audio depuis Google Drive.';
                console.error(errorMessage, error);
                document.getElementById('error-message').innerText = errorMessage;
            });
        }
    </script>
</body>
</html>
