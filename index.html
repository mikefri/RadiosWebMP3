<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://www.gstatic.com; object-src 'none';">
  <title>Lecteur audio depuis Google Drive</title>
</head>
<body>
  <h1>Lecteur audio depuis Google Drive</h1>

  <!-- Bouton de connexion Google -->
  <div id="g_id_onload"
       data-client_id="702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com"
       data-auto_select="true"
       data-itp_support="true"></div>

  <div id="g_id_signin"
       data-type="standard"
       data-shape="pill"
       data-theme="outline"
       data-text="signin_with"
       data-size="large"></div>

  <div id="audio-list"></div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    // Initialiser Google Identity Services (GIS) après le chargement du script
    window.onload = function() {
      console.log('Initialisation du bouton de connexion Google');
      google.accounts.id.initialize({
        client_id: '702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com',
        callback: handleCredentialResponse
      });

      google.accounts.id.renderButton(
        document.getElementById("g_id_signin"),
        { theme: "outline", size: "large" }
      );
      console.log('Bouton de connexion Google rendu');
    };

    // Cette fonction est appelée lorsque l'utilisateur se connecte avec Google
    function handleCredentialResponse(response) {
      console.log("Réponse reçue du bouton de connexion Google:", response);
      const id_token = response.credential;
      console.log("ID Token reçu:", id_token);

      // Utiliser le token pour accéder à l'API Google Drive
      authenticate(id_token).then(() => {
        console.log('Authentification réussie');
        listFiles();
      }).catch(err => {
        console.error("Erreur d'authentification:", err);
      });
    }

    // Authentification avec Google API en utilisant l'ID Token
    function authenticate(id_token) {
      return new Promise((resolve, reject) => {
        console.log('Chargement de l\'API Google Client');
        gapi.load('client:auth2', function() {
          console.log('API Google Client chargée');
          gapi.auth2.init({
            client_id: '702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com'
          }).then(function() {
            console.log('Authentification avec le token ID');
            gapi.auth2.getAuthInstance().signIn({
              id_token: id_token
            }).then(resolve, reject);
          });
        });
      });
    }

    // Lister les fichiers audio du dossier spécifique dans Google Drive
    function listFiles() {
      console.log("Chargement de l'API Google Drive");
      gapi.client.load('drive', 'v3', function() {
        console.log('API Google Drive chargée');
        gapi.client.drive.files.list({
          q: `'11n9RVF-ZjTBOLMvoYB7asAs4A8hUfeYu' in parents and mimeType contains 'audio' and trashed = false`,
          fields: 'files(id, name, mimeType)'
        }).then(response => {
          console.log("Réponse de l'API Google Drive:", response);
          const files = response.result.files;
          if (!files || files.length === 0) {
            console.log('Aucun fichier audio trouvé dans le dossier.');
            document.getElementById('audio-list').innerText = 'Aucun fichier trouvé.';
            return;
          }

          console.log('Fichiers audio trouvés:', files);
          files.forEach(file => {
            console.log('Création du lecteur pour le fichier:', file.name);
            const container = document.createElement('div');
            container.innerHTML = `
              <h3>${file.name}</h3>
              <audio controls>
                <source src="https://www.googleapis.com/drive/v3/files/${file.id}?alt=media&key=AIzaSyCFIShJe5FjUrK00QAq7zGxHhXLuTbKxZA" type="${file.mimeType}">
                Votre navigateur ne supporte pas l'audio.
              </audio>
            `;
            document.getElementById('audio-list').appendChild(container);
          });
        }).catch(err => {
          console.error('Erreur API:', err);
        });
      });
    }
  </script>
</body>
</html>
