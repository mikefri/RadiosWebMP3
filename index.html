<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com https://accounts.google.com 'unsafe-inline'; object-src 'none';">
    <title>Lecteur audio depuis Google Drive</title>
    <style>
        #audio-list div {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #error-message {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Lecteur audio depuis Google Drive</h1>

    <div id="g_id_onload"
         data-client_id="702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com" data-auto_select="false"
         data-itp_support="true"
         data-callback="handleCredentialResponse">
    </div>

    <div class="g_id_signin"
         data-type="standard"
         data-shape="pill"
         data-theme="outline"
         data-text="signin_with"
         data-size="large"
         data-client_id="702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com"> </div>

    <div id="audio-list"></div>
    <div id="error-message"></div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script async defer src="https://apis.google.com/js/api.js"
            onload="gapiLoaded"></script>

    <script>
        // Remplacez par l'ID de votre dossier "music" sur Google Drive
        const MUSIC_FOLDER_ID = '11n9RVF-ZjTBOLMvoYB7asAs4A8hUfeYu';

        let googleAuth;
        let isSignedIn = false;

        function gapiLoaded() {
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                clientId: '702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com', // Encore une fois, assurez-vous que c'est le bon ID
                scope: 'https://www.googleapis.com/auth/drive.readonly' // Scope pour lire les fichiers Drive
            }).then(() => {
                googleAuth = gapi.auth2.getAuthInstance();
                isSignedIn = googleAuth.isSignedIn.get();
                googleAuth.isSignedIn.listen(updateSigninStatus);
                if (isSignedIn) {
                    console.log('Déjà connecté.');
                    listFiles();
                }
                // Le bouton de connexion est géré par g_id_onload et g_id_signin
            }).catch(error => {
                console.error('Erreur lors de l\'initialisation de gapi:', error);
                document.getElementById('error-message').innerText = 'Erreur lors de la connexion à Google.';
            });
        }

        function handleCredentialResponse(response) {
            console.log("ID Token:", response.credential);
            // Ici, vous pouvez envoyer l'ID Token à votre serveur backend pour une authentification plus poussée si nécessaire.
            // Pour cet exemple côté client uniquement, nous allons essayer d'initialiser gapi directement.
            initClient();
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                console.log('Connecté.');
                document.getElementById('error-message').innerText = '';
                listFiles();
            } else {
                console.log('Non connecté.');
                document.getElementById('audio-list').innerText = '';
                document.getElementById('error-message').innerText = 'Veuillez vous connecter à Google pour accéder à vos fichiers audio.';
            }
        }

        function listFiles() {
            if (!isSignedIn || !gapi.client || !gapi.client.drive) {
                console.error('Client Google API non initialisé ou non connecté.');
                document.getElementById('error-message').innerText = 'Erreur : Client Google API non initialisé.';
                return;
            }

            gapi.client.drive.files.list({
                q: `'${11n9RVF-ZjTBOLMvoYB7asAs4A8hUfeYu}' in parents and mimeType contains 'audio' and trashed = false`,
                fields: 'files(id, name, mimeType)'
            }).then(response => {
                const files = response.result.files;
                const audioListDiv = document.getElementById('audio-list');
                audioListDiv.innerHTML = ''; // Clear previous list

                if (!files || files.length === 0) {
                    audioListDiv.innerText = 'Aucun fichier audio trouvé dans le dossier.';
                    return;
                }

                files.forEach(file => {
                    const container = document.createElement('div');
                    container.innerHTML = `
                        <h3>${file.name}</h3>
                        <audio controls>
                            <source src="https://drive.google.com/uc?export=download&id=${file.id}" type="${file.mimeType}">
                            Votre navigateur ne supporte pas l'audio.
                        </audio>
                    `;
                    audioListDiv.appendChild(container);
                });
            }).catch(error => {
                console.error('Erreur lors de la récupération des fichiers:', error);
                document.getElementById('error-message').innerText = 'Erreur lors de la récupération des fichiers audio depuis Google Drive.';
            });
        }
    </script>
</body>
</html>
