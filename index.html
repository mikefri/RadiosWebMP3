<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://www.gstatic.com https://accounts.google.com 'unsafe-inline'; object-src 'none';">
  <title>Lecteur audio depuis Google Drive</title>
</head>
<body>
  <h1>Lecteur audio depuis Google Drive</h1>

  <div id="g_id_onload"
       data-client_id="702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com"
       data-auto_select="true"
       data-itp_support="true"></div>

  <div id="g_id_signin"
       data-type="standard"
       data-shape="pill"
       data-theme="outline"
       data-text="signin_with"
       data-size="large"></div>

  <div id="audio-list"></div>

  <!-- Le script Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    // Attendre que le script Google Identity soit chargé avant de l'utiliser
    window.onload = function() {
      if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
        google.accounts.id.initialize({
          client_id: '702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com',
          callback: handleCredentialResponse
        });

        google.accounts.id.renderButton(
          document.getElementById("g_id_signin"),
          { theme: "outline", size: "large" }
        );
      } else {
        console.error("Le script Google Identity Services n'a pas pu être chargé.");
      }
    };

    // Fonction de réponse de l'ID Token
    function handleCredentialResponse(response) {
      const id_token = response.credential;
      console.log("ID Token: " + id_token);

      authenticate(id_token).then(() => {
        console.log('Authentification réussie');
        listFiles();
      }).catch(err => {
        console.error("Erreur d'authentification:", err);
      });
    }

    // Authentification avec Google API
    function authenticate(id_token) {
      return new Promise((resolve, reject) => {
        if (typeof gapi !== 'undefined') {
          gapi.load('client:auth2', function() {
            gapi.auth2.init({
              client_id: '702949477364-khje9k7kp6o2maappfucllp3u6va77vt.apps.googleusercontent.com'
            }).then(function() {
              gapi.auth2.getAuthInstance().signIn({
                id_token: id_token
              }).then(resolve, reject);
            });
          });
        } else {
          console.error("gapi n'est pas défini, vérifie le chargement du script.");
          reject(new Error("gapi non disponible"));
        }
      });
    }

    // Liste des fichiers audio sur Google Drive
    function listFiles() {
      gapi.client.load('drive', 'v3', function() {
        gapi.client.drive.files.list({
          q: `'11n9RVF-ZjTBOLMvoYB7asAs4A8hUfeYu' in parents and mimeType contains 'audio' and trashed = false`,
          fields: 'files(id, name, mimeType)'
        }).then(response => {
          console.log('Fichiers trouvés :', response.result.files);
          const files = response.result.files;
          if (!files || files.length === 0) {
            document.getElementById('audio-list').innerText = 'Aucun fichier trouvé.';
            return;
          }

          files.forEach(file => {
            const container = document.createElement('div');
            container.innerHTML = `
              <h3>${file.name}</h3>
              <audio controls>
                <source src="https://www.googleapis.com/drive/v3/files/${file.id}?alt=media&key=AIzaSyCFIShJe5FjUrK00QAq7zGxHhXLuTbKxZA" type="${file.mimeType}">
                Votre navigateur ne supporte pas l'audio.
              </audio>
            `;
            document.getElementById('audio-list').appendChild(container);
          });
        }).catch(err => {
          console.error('Erreur API:', err);
        });
      });
    }
  </script>
</body>
</html>
