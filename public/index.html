<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <title>MP3 - RadiosWeb</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #f0eafa, #d4f4e2, #e0f7fa, #e6e9f9);
      background-size: 400% 400%;
      animation: gradientShift 20s ease infinite;
      color: #333;
      min-height: 100vh;
      padding-top: 120px;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(15px);
      padding: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 3em;
      margin: 0 0 10px;
      color: #6a5acd;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    }
    .now-playing {
      font-weight: bold;
      font-size: 1.3em;
      color: #6a5acd;
      margin-bottom: 10px;
      animation: pulse-now-playing 2s ease-in-out infinite;
      max-width: 90%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @keyframes pulse-now-playing {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .audio-player {
      margin-top: 10px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(15px);
      border-radius: 30px;
      padding: 20px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 20px;
      max-width: 700px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    audio {
      flex-grow: 1;
      margin: 0 15px;
    }
    .controls-button {
      background: none;
      border: none;
      color: #ba97ff;
      font-size: 1.8em;
      cursor: pointer;
      transition: transform 0.3s ease, color 0.3s ease;
    }
    .controls-button:hover {
      transform: scale(1.2);
      color: #9ed7ff;
    }
    #shuffleButton.active {
      color: #9ed7ff;
    }
    .progress-container {
      width: 100%;
      max-width: 400px;
    }
    #progressBar {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      background: #ddd;
      border-radius: 10px;
      outline: none;
      cursor: pointer;
    }
    #progressBar::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: #ba97ff;
      border-radius: 50%;
      cursor: pointer;
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: #777;
      margin-top: 5px;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: rgba(255, 255, 255, 0.85);
      padding: 30px;
      border-radius: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      margin-top: 100px;
    }
    .tab-container {
      display: flex;
      margin-bottom: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    .tab-button {
      padding: 12px 20px;
      border: none;
      background: rgba(186, 151, 255, 0.2);
      color: #6a5acd;
      cursor: pointer;
      border-radius: 30px 30px 0 0;
      font-size: 1em;
      margin-right: 10px;
      transition: all 0.3s;
    }
    .tab-button:hover {
      background: rgba(186, 151, 255, 0.4);
    }
    .tab-button.active {
      background: #ba97ff;
      color: white;
    }
    .search-bar {
      margin-left: auto;
      flex-grow: 1;
      min-width: 200px;
    }
    .search-bar input[type="text"] {
      padding: 12px 16px;
      border-radius: 30px;
      border: none;
      background: rgba(255, 255, 255, 0.8);
      color: #333;
      width: 100%;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .search-bar input[type="text"]::placeholder {
      color: #888;
    }
    .tab-content {
      background: rgba(255, 255, 255, 0.7);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    #playlist li, #currentPlaylist li, #savedPlaylistsList li {
      padding: 15px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 15px;
      margin-bottom: 10px;
    }
    #playlist li:hover, #currentPlaylist li:hover {
      background: rgba(186, 151, 255, 0.2);
      transform: translateY(-3px);
    }
    .current-song-playing {
      background: rgba(186, 151, 255, 0.3) !important;
      border-left: 5px solid #ba97ff;
    }
    .current-song-playing .song-title-artist {
      color: #6a5acd;
      font-weight: bold;
    }
    .list-item-icons i {
      font-size: 1.4em;
      color: #ba97ff;
      transition: all 0.3s;
    }
    .list-item-icons i:hover {
      transform: scale(1.2);
    }
    .add-to-playlist-icon:hover { color: #9ed7ff; }
    .play-song-icon:hover, .play-current:hover { color: #6a5acd; }
    .delete-song-icon:hover { color: #ff9ec9; }
    footer {
      text-align: center;
      margin-top: 40px;
      padding-top: 20px;
      color: #777;
    }
    #savePlaylistButton {
      background: linear-gradient(45deg, #ba97ff, #9ed7ff);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s;
    }
    #savePlaylistButton:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>üéß MP3 - RadiosWeb</h1>
    <div id="currentSongTitle" class="now-playing">Aucune chanson en cours</div>
    <div class="audio-player">
      <audio id="audioPlayer" controls></audio>
      <div class="progress-container">
        <input type="range" id="progressBar" value="0" min="0" max="100">
        <div class="time-display">
          <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
        </div>
      </div>
      <button id="shuffleButton" class="controls-button" title="Activer/D√©sactiver la lecture al√©atoire">
        <i class="fas fa-random"></i>
      </button>
      <button id="prevButton" class="controls-button" title="Chanson pr√©c√©dente">
        <i class="fas fa-backward"></i>
      </button>
      <button id="nextButton" class="controls-button" title="Chanson suivante">
        <i class="fas fa-forward"></i>
      </button>
      <button id="castButton" class="controls-button" title="Caster sur un appareil" style="display:none;">
        <i class="fa-solid fa-chromecast"></i>
      </button>
    </div>
  </div>
  <div class="container">
    <div class="tab-container">
      <button class="tab-button active" data-tab="playlist-section">Liste des Chansons</button>
      <button class="tab-button" data-tab="current-playlist-section">Playlist Actuelle</button>
      <section class="search-bar">
        <input type="text" id="searchInput" placeholder="Search un titre, un artiste...">
      </section>
    </div>
    <section id="playlist-section" class="tab-content">
      <h2>Liste des Chansons</h2>
      <ul id="playlist"></ul>
    </section>
    <section id="current-playlist-section" class="tab-content" style="display: none;">
      <h2>Playlist Actuelle</h2>
      <div class="playlist-actions">
        <button id="savePlaylistButton" title="Sauvegarder la Playlist">
          <i class="fa fa-save" style="margin-right: 6px;"></i> Sauvegarder
        </button>
      </div>
      <ul id="currentPlaylist"></ul>
      <section id="savedPlaylistsSection" style="display: none;">
        <h2>Playlists Sauvegard√©es</h2>
        <ul id="savedPlaylistsList"></ul>
      </section>
    </section>
    <footer>
      <p>&copy; 2025 Fait avec ‚ù§Ô∏è par Micfri</p>
    </footer>
  </div>
  <script src="//www.gstatic.com/cv/js/sender/receiver_libs.js?loadCastFramework=1"></script>
  <script>
    // Ton script.js original reste inchang√© (seules les classes et IDs sont pr√©serv√©s)
    // Je le copie tel quel pour conserver toutes les fonctionnalit√©s
    const audioPlayer = document.getElementById('audioPlayer');
    const playlistElement = document.getElementById('playlist');
    const currentPlaylistElement = document.getElementById('currentPlaylist');
    const currentSongTitleElement = document.getElementById('currentSongTitle');
    const searchInput = document.getElementById('searchInput');
    const shuffleButton = document.getElementById('shuffleButton');
    const savePlaylistButton = document.getElementById('savePlaylistButton');
    const savedPlaylistsSection = document.getElementById('savedPlaylistsSection');
    const savedPlaylistsList = document.getElementById('savedPlaylistsList');
    const progressBar = document.getElementById('progressBar');
    const currentTimeSpan = document.getElementById('currentTime');
    const durationSpan = document.getElementById('duration');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    let allSongs = [];
    let currentPlaylist = [];
    let currentSongIndex = -1;
    let currentPlaylistName = null;
    let isShuffleMode = false;

    async function loadSongs() {
        try {
            const response = await fetch('https://mikefri.github.io/ma-playlist/audios-list.json');
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status} - √âchec du chargement de audios-list.json`);
            }
            const data = await response.json();
            if (Array.isArray(data)) {
                allSongs = data;
            } else {
                console.error("La structure du JSON n'est pas un tableau direct:", data);
                alert("Erreur: La liste des chansons n'est pas au format attendu (tableau).");
                return;
            }
            displayAllSongs();
        } catch (error) {
            console.error('Erreur lors du chargement des chansons:', error);
            alert('Impossible de charger la liste des chansons depuis git. V√©rifiez l\'URL et votre r√©seau.');
        }
    }
    function displayAllSongs() {
        if (!playlistElement) return;
        playlistElement.innerHTML = '';
        if (!Array.isArray(allSongs) || allSongs.length === 0) {
            playlistElement.innerHTML = '<li class="empty-list">Aucune chanson √† afficher.</li>';
            return;
        }
        allSongs.forEach((song, index) => {
            const listItem = document.createElement('li');
            const title = song.title || 'Titre inconnu';
            const artist = song.artist || 'Artiste inconnu';
            listItem.innerHTML = `
                <span class="song-title-artist">${title} - ${artist}</span>
                <div class="list-item-icons">
                    <i class="fas fa-plus-circle add-to-playlist-icon" data-original-index="${index}" title="Ajouter √† la playlist actuelle"></i>
                    <i class="fas fa-play-circle play-song-icon" data-original-index="${index}" title="√âcouter cette chanson"></i>
                </div>
            `;
            playlistElement.appendChild(listItem);
        });
    }
    function addSongToCurrentPlaylist(song) {
        currentPlaylist.push(song);
        updateCurrentPlaylistDisplay();
    }
    function updateCurrentPlaylistDisplay() {
        if (!currentPlaylistElement) {
            console.error("L'√©l√©ment 'currentPlaylist' n'a pas √©t√© trouv√©.");
            return;
        }
        currentPlaylistElement.innerHTML = '';
        if (currentPlaylist.length === 0) {
            currentPlaylistElement.innerHTML = '<li class="empty-playlist">Votre playlist est vide. Ajoutez des chansons !</li>';
            if (currentSongTitleElement) currentSongTitleElement.textContent = 'Aucune chanson en cours';
            document.title = 'MP3 - RadiosWeb';
            return;
        }
        currentPlaylist.forEach((song, index) => {
            const listItem = document.createElement('li');
            const title = song.title || 'Titre inconnu';
            const artist = song.artist || 'Artiste inconnu';
            let moveIcons = '';
            if (index > 0) {
                moveIcons += `<i class="fas fa-arrow-up move-up-icon" data-playlist-index="${index}" title="Monter la chanson"></i>`;
            }
            if (index < currentPlaylist.length - 1) {
                moveIcons += `<i class="fas fa-arrow-down move-down-icon" data-playlist-index="${index}" title="Descendre la chanson"></i>`;
            }
            listItem.innerHTML = `
                <span class="song-title-artist" data-playlist-index="${index}" title="Jouer cette chanson">${title} - ${artist}</span>
                <div class="list-item-icons">
                    ${moveIcons}
                    <i class="fas fa-trash delete-song-icon" data-playlist-index="${index}" title="Supprimer de la playlist"></i>
                </div>
            `;
           
            if (index === currentSongIndex) {
                listItem.classList.add('current-song-playing');
            }
            currentPlaylistElement.appendChild(listItem);
        });
        const playingElement = currentPlaylistElement.querySelector('.current-song-playing');
        if (playingElement) {
            playingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    function playSong(song, indexInCurrentPlaylist) {
        if (!song || !song.path) return;
       
        const previouslyPlaying = currentPlaylistElement.querySelector('.current-song-playing');
        if (previouslyPlaying) {
            previouslyPlaying.classList.remove('current-song-playing');
        }
        audioPlayer.src = song.path;
        currentSongIndex = indexInCurrentPlaylist;
       
        const newPlayingElement = currentPlaylistElement.children[currentSongIndex];
        if (newPlayingElement) {
            newPlayingElement.classList.add('current-song-playing');
            newPlayingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        if (currentSongTitleElement) currentSongTitleElement.textContent = `${song.title || 'Titre inconnu'} - ${song.artist || 'Artiste inconnu'}`;
        document.title = `${song.title || 'Titre inconnu'} - ${song.artist || 'Artiste inconnu'}`;
        audioPlayer.play();
    }
    function playNextSong() {
        if (currentPlaylist.length === 0) return;
        if (isShuffleMode) {
            let newIndex;
            do { newIndex = Math.floor(Math.random() * currentPlaylist.length); }
            while (newIndex === currentSongIndex && currentPlaylist.length > 1);
            currentSongIndex = newIndex;
        } else {
            currentSongIndex = (currentSongIndex + 1) % currentPlaylist.length;
        }
        playSong(currentPlaylist[currentSongIndex], currentSongIndex);
    }
    function playPreviousSong() {
        if (currentPlaylist.length === 0) return;
        if (isShuffleMode) {
            let newIndex;
            do { newIndex = Math.floor(Math.random() * currentPlaylist.length); }
            while (newIndex === currentSongIndex && currentPlaylist.length > 1);
            currentSongIndex = newIndex;
        } else {
            currentSongIndex = (currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
        }
        playSong(currentPlaylist[currentSongIndex], currentSongIndex);
    }
    function moveSongUp(index) {
        if (index > 0) {
            [currentPlaylist[index], currentPlaylist[index - 1]] = [currentPlaylist[index - 1], currentPlaylist[index]];
            if (currentSongIndex === index) {
                currentSongIndex--;
            } else if (currentSongIndex === index - 1) {
                currentSongIndex++;
            }
            updateCurrentPlaylistDisplay();
        }
    }
    function moveSongDown(index) {
        if (index < currentPlaylist.length - 1) {
            [currentPlaylist[index], currentPlaylist[index + 1]] = [currentPlaylist[index + 1], currentPlaylist[index]];
            if (currentSongIndex === index) {
                currentSongIndex++;
            } else if (currentSongIndex === index + 1) {
                currentSongIndex--;
            }
            updateCurrentPlaylistDisplay();
        }
    }
    function toggleShuffle() {
        isShuffleMode = !isShuffleMode;
        if (shuffleButton) {
            shuffleButton.classList.toggle('active', isShuffleMode);
        }
    }
    function searchSongs() {
        const searchTerm = searchInput.value.toLowerCase();
        playlistElement.innerHTML = '';
        if (!Array.isArray(allSongs) || allSongs.length === 0) return;
        const filteredSongs = allSongs.filter(song =>
            (song.title && song.title.toLowerCase().includes(searchTerm)) ||
            (song.artist && song.artist.toLowerCase().includes(searchTerm))
        );
        if (filteredSongs.length === 0) {
            playlistElement.innerHTML = '<li class="empty-list">Aucun r√©sultat trouv√©.</li>';
            return;
        }
        filteredSongs.forEach((song) => {
            const listItem = document.createElement('li');
            const originalIndex = allSongs.findIndex(s => s.path === song.path);
            if (originalIndex === -1) return;
            const title = song.title || 'Titre inconnu';
            const artist = song.artist || 'Artiste inconnu';
            listItem.innerHTML = `
                <span class="song-title-artist">${title} - ${artist}</span>
                <div class="list-item-icons">
                    <i class="fas fa-plus-circle add-to-playlist-icon" data-original-index="${originalIndex}" title="Ajouter √† la playlist actuelle"></i>
                    <i class="fas fa-play-circle play-song-icon" data-original-index="${originalIndex}" title="√âcouter cette chanson"></i>
                </div>
            `;
            playlistElement.appendChild(listItem);
        });
    }
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
    }
    async function savePlaylistOnVercel() {
        if (currentPlaylist.length === 0) {
            alert("Votre playlist actuelle est vide.");
            return;
        }
        const playlistName = prompt("Nommez votre playlist :");
        if (playlistName) {
            try {
                const response = await fetch('/api/save-playlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: playlistName, playlist: currentPlaylist }),
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    alert("Playlist sauvegard√©e !");
                    loadSavedPlaylistsFromVercel();
                } else {
                    throw new Error(result.message || `Erreur lors de la sauvegarde: ${response.status}`);
                }
            } catch (error) {
                console.error("Erreur lors de la sauvegarde :", error);
                alert("Impossible de sauvegarder la playlist. D√©tails : " + error.message);
            }
        }
    }
    async function loadSavedPlaylistsFromVercel() {
        if (!savedPlaylistsList) return;
        savedPlaylistsList.innerHTML = '';
        try {
            const response = await fetch('/api/load-playlists?action=list');
            if (!response.ok) throw new Error(`√âchec du chargement : ${response.status}`);
            const savedPlaylists = await response.json();
            if (savedPlaylists.length > 0) {
                savedPlaylists.forEach(pl => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span class="playlist-bullet"></span>
                        <span class="song-title-artist">${pl.name}</span>
                        <div class="list-item-icons">
                            <i class="fas fa-folder-open load-saved-playlist-icon" data-playlist-id="${pl.id}" title="Charger cette playlist"></i>
                            <i class="fas fa-trash delete-saved-playlist-icon" data-playlist-id="${pl.id}" data-playlist-name="${pl.name}" title="Supprimer cette playlist"></i>
                        </div>
                    `;
                    savedPlaylistsList.appendChild(listItem);
                });
                if (savedPlaylistsSection) savedPlaylistsSection.style.display = 'block';
            } else {
                if (savedPlaylistsSection) savedPlaylistsSection.style.display = 'none';
            }
        } catch (error) {
            console.error("Erreur chargement playlists:", error);
            if (savedPlaylistsSection) savedPlaylistsSection.style.display = 'none';
        }
    }
    async function loadPlaylistFromVercel(playlistId) {
        try {
            const response = await fetch(`/api/load-playlists?action=get&id=${playlistId}`);
            if (!response.ok) throw new Error(`√âchec du chargement : ${response.status}`);
            const playlistData = await response.json();
            currentPlaylist = playlistData.playlist;
            updateCurrentPlaylistDisplay();
            currentPlaylistName = playlistData.name;
            const tabButton = document.querySelector('.tab-button[data-tab="current-playlist-section"]');
            if (tabButton) tabButton.click();
        } catch (error) {
            console.error(`Erreur chargement playlist ${playlistId}:`, error);
            alert(`Impossible de charger la playlist. D√©tails : ` + error.message);
        }
    }
    async function deletePlaylistOnVercel(playlistId, playlistName) {
        if (confirm(`√ätes-vous s√ªr de vouloir supprimer la playlist "${playlistName}" ?`)) {
            try {
                const response = await fetch('/api/delete-playlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: playlistId }),
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    alert(`Playlist "${playlistName}" supprim√©e.`);
                    loadSavedPlaylistsFromVercel();
                    if (currentPlaylistName === playlistName) {
                        currentPlaylist = [];
                        updateCurrentPlaylistDisplay();
                        if (audioPlayer) { audioPlayer.pause(); audioPlayer.src = ''; }
                        if (currentSongTitleElement) currentSongTitleElement.textContent = 'Aucune chanson en cours';
                        document.title = 'MP3 - RadiosWeb';
                        currentPlaylistName = null;
                        currentSongIndex = -1;
                    }
                } else {
                    throw new Error(result.message || `Erreur suppression: ${response.status}`);
                }
            } catch (error) {
                console.error("Erreur suppression:", error);
                alert("Impossible de supprimer la playlist. D√©tails : " + error.message);
            }
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        loadSongs();
        loadSavedPlaylistsFromVercel();
        if (playlistElement) {
            playlistElement.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('add-to-playlist-icon')) {
                    const originalIndex = parseInt(target.dataset.originalIndex);
                    if (!isNaN(originalIndex) && allSongs[originalIndex]) {
                        addSongToCurrentPlaylist(allSongs[originalIndex]);
                    }
                } else if (target.classList.contains('play-song-icon')) {
                    const originalIndex = parseInt(target.dataset.originalIndex);
                    if (!isNaN(originalIndex) && allSongs[originalIndex]) {
                        currentPlaylist = [allSongs[originalIndex]];
                        playSong(allSongs[originalIndex], 0);
                        const tabButton = document.querySelector('.tab-button[data-tab="current-playlist-section"]');
                        if (tabButton) tabButton.click();
                    }
                }
            });
        }
        if (currentPlaylistElement) {
            currentPlaylistElement.addEventListener('click', (event) => {
                const target = event.target;
                const playlistIndex = parseInt(target.dataset.playlistIndex);
                if (isNaN(playlistIndex) || playlistIndex < 0 || playlistIndex >= currentPlaylist.length) return;
                if (target.classList.contains('song-title-artist')) {
                    playSong(currentPlaylist[playlistIndex], playlistIndex);
                } else if (target.classList.contains('delete-song-icon')) {
                    currentPlaylist.splice(playlistIndex, 1);
                    if (playlistIndex < currentSongIndex) {
                        currentSongIndex--;
                    } else if (playlistIndex === currentSongIndex) {
                        audioPlayer.pause();
                        audioPlayer.src = '';
                        if (currentSongTitleElement) currentSongTitleElement.textContent = 'Aucune chanson en cours';
                        document.title = 'MP3 - RadiosWeb';
                        currentSongIndex = -1;
                    }
                    updateCurrentPlaylistDisplay();
                } else if (target.classList.contains('move-up-icon')) {
                    moveSongUp(playlistIndex);
                } else if (target.classList.contains('move-down-icon')) {
                    moveSongDown(playlistIndex);
                }
            });
        }
       
        if (savedPlaylistsList) {
            savedPlaylistsList.addEventListener('click', (event) => {
                const target = event.target;
                const listItem = target.closest('li');
                if (!listItem) return;
                if (target.classList.contains('load-saved-playlist-icon')) {
                    const playlistId = target.dataset.playlistId;
                    if (playlistId) loadPlaylistFromVercel(playlistId);
                } else if (target.classList.contains('delete-saved-playlist-icon')) {
                    const playlistId = target.dataset.playlistId;
                    const playlistName = target.dataset.playlistName;
                    if (playlistId && playlistName) deletePlaylistOnVercel(playlistId, playlistName);
                } else if (target.classList.contains('song-title-artist')) {
                    const loadIcon = listItem.querySelector('.load-saved-playlist-icon');
                    if (loadIcon) {
                        const playlistId = loadIcon.dataset.playlistId;
                        if (playlistId) loadPlaylistFromVercel(playlistId);
                    }
                }
            });
        }
        if (audioPlayer) {
            audioPlayer.addEventListener('ended', playNextSong);
            audioPlayer.addEventListener('timeupdate', () => {
                const current = audioPlayer.currentTime;
                const duration = audioPlayer.duration;
                if (isNaN(duration)) {
                    if (progressBar) progressBar.value = 0;
                    if (currentTimeSpan) currentTimeSpan.textContent = '0:00';
                    if (durationSpan) durationSpan.textContent = '0:00';
                } else {
                    if (progressBar) progressBar.value = (current / duration) * 100;
                    if (currentTimeSpan) currentTimeSpan.textContent = formatTime(current);
                    if (durationSpan) durationSpan.textContent = formatTime(duration);
                }
            });
            if (progressBar) {
                progressBar.addEventListener('input', () => {
                    audioPlayer.currentTime = (progressBar.value * audioPlayer.duration) / 100;
                });
            }
        }
       
        if (prevButton) prevButton.addEventListener('click', playPreviousSong);
        if (nextButton) nextButton.addEventListener('click', playNextSong);
        if (shuffleButton) shuffleButton.addEventListener('click', toggleShuffle);
        if (searchInput) searchInput.addEventListener('input', searchSongs);
        if (savePlaylistButton) savePlaylistButton.addEventListener('click', savePlaylistOnVercel);
       
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                button.classList.add('active');
                const targetTabContent = document.getElementById(tabId);
                if (targetTabContent) targetTabContent.style.display = 'block';
            });
        });
        const defaultTabButton = document.querySelector('.tab-button[data-tab="playlist-section"]');
        if (defaultTabButton) defaultTabButton.click();
    });
    window['__onGCastApiAvailable'] = function(isAvailable) {
        if (isAvailable) {
            initializeCastApi();
        } else {
            console.error('Google Cast API non disponible.');
            const castButton = document.getElementById('castButton');
            if(castButton) castButton.style.display = 'none';
        }
    };
    function initializeCastApi() {
        cast.framework.CastContext.getInstance().setOptions({
            receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
            autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });
        const castContext = cast.framework.CastContext.getInstance();
        const castButton = document.getElementById('castButton');
        castContext.addEventListener(
            cast.framework.CastContextEventType.CAST_STATE_CHANGED,
            (event) => {
                if (event.castState === cast.framework.CastState.NOT_CONNECTED) {
                    if (castButton) castButton.classList.remove('connected');
                } else if (event.castState === cast.framework.CastState.CONNECTED) {
                    if (castButton) castButton.classList.add('connected');
                    currentCastSession = castContext.getCurrentSession();
                    if (!audioPlayer.paused && audioPlayer.src) {
                        loadMediaOnCast(audioPlayer.src, audioPlayer.currentTime);
                    }
                }
            }
        );
        castContext.addEventListener(
            cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
            (event) => {
                if (event.sessionState === cast.framework.SessionState.SESSION_ENDED) {
                    currentCastSession = null;
                    if (audioPlayer.dataset.wasPlayingBeforeCast === 'true') {
                         audioPlayer.play();
                    }
                    delete audioPlayer.dataset.wasPlayingBeforeCast;
                } else if (event.sessionState === cast.framework.SessionState.SESSION_STARTED) {
                    currentCastSession = castContext.getCurrentSession();
                }
            }
        );
    }
    let currentCastSession = null;
    function loadMediaOnCast(mediaUrl, startTime = 0) {
        if (!currentCastSession || !mediaUrl) return;
        const mediaInfo = new chrome.cast.media.MediaInfo(mediaUrl, 'audio/mpeg');
        const request = new chrome.cast.media.LoadRequest(mediaInfo);
        request.autoplay = true;
        request.currentTime = startTime;
        currentCastSession.loadMedia(request).then(
            () => {
                if (!audioPlayer.paused) {
                    audioPlayer.dataset.wasPlayingBeforeCast = 'true';
                    audioPlayer.pause();
                } else {
                    audioPlayer.dataset.wasPlayingBeforeCast = 'false';
                }
            },
            (errorCode) => {
                console.error('Erreur lors du chargement du m√©dia sur Cast:', errorCode);
                if (audioPlayer.dataset.wasPlayingBeforeCast === 'true') {
                     audioPlayer.play();
                }
                delete audioPlayer.dataset.wasPlayingBeforeCast;
            }
        );
    }
    if (audioPlayer) {
        audioPlayer.addEventListener('play', function() {
            if (currentCastSession && (currentCastSession.getMediaSession() === null || (currentCastSession.getMediaSession() && currentCastSession.getMediaSession().media.contentId !== audioPlayer.src))) {
                loadMediaOnCast(audioPlayer.src, audioPlayer.currentTime);
            } else if (currentCastSession && currentCastSession.getMediaSession()) {
                currentCastSession.getMediaSession().play();
                audioPlayer.pause();
            }
        });
        audioPlayer.addEventListener('pause', function() {
            if (currentCastSession && currentCastSession.getMediaSession()) {
                currentCastSession.getMediaSession().pause();
            }
        });
        audioPlayer.addEventListener('loadeddata', function() {
            if (currentCastSession && currentCastSession.getMediaSession() && currentCastSession.getMediaSession().media.contentId !== audioPlayer.src) {
                loadMediaOnCast(audioPlayer.src, 0);
            }
        });
    }
  </script>
</body>
</html>
